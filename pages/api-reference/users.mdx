import { Callout, Tabs, Tab } from 'nextra/components'

# 用户管理 API

<Callout type="info">
用户管理 API 提供了完整的用户 CRUD 操作，包括注册、登录、查询和更新功能。
</Callout>

## 基础信息

- **Base URL**: `/api/users`
- **认证方式**: JWT Token (部分接口需要)
- **数据格式**: JSON
- **字符编码**: UTF-8

## API 端点列表

| 方法 | 端点 | 描述 | 认证 |
|------|------|------|------|
| POST | `/api/users` | 创建用户（注册） | 否 |
| GET | `/api/users` | 获取用户列表 | 是 |
| GET | `/api/users/[id]` | 获取用户详情 | 否 |
| PUT | `/api/users/[id]` | 更新用户信息 | 是 |
| DELETE | `/api/users/[id]` | 删除用户 | 是 |
| GET | `/api/users/[id]/posts` | 获取用户文章 | 否 |

## 数据模型

### User 对象

```typescript
interface User {
  id: string
  email: string
  username: string
  avatar?: string
  createdAt: string
  updatedAt: string
  // 密码字段在响应中永远不会返回
}
```

### UserProfile 对象（包含统计信息）

```typescript
interface UserProfile extends User {
  _count: {
    posts: number
    comments: number
  }
  posts?: Post[] // 可选，根据接口而定
}
```

## API 详细说明

### 创建用户 (注册)

创建一个新用户账户。

<Tabs items={['请求', '响应', '错误']}>
  <Tab>
    ```http
    POST /api/users
    Content-Type: application/json

    {
      "email": "user@example.com",
      "username": "newuser",
      "password": "securepassword123"
    }
    ```

    **请求参数**:
    - `email` (string, required): 用户邮箱，必须唯一
    - `username` (string, required): 用户名，3-20字符，必须唯一
    - `password` (string, required): 密码，最少6字符
  </Tab>
  <Tab>
    ```json
    {
      "id": "clx1234567890",
      "email": "user@example.com",
      "username": "newuser",
      "avatar": null,
      "createdAt": "2024-01-15T10:30:00.000Z"
    }
    ```

    **响应状态码**: `201 Created`
  </Tab>
  <Tab>
    **400 Bad Request** - 参数验证失败
    ```json
    {
      "error": "用户已存在",
      "details": "邮箱或用户名已被使用"
    }
    ```

    **500 Internal Server Error** - 服务器错误
    ```json
    {
      "error": "服务器错误",
      "message": "创建用户失败"
    }
    ```
  </Tab>
</Tabs>

### 获取用户列表

获取所有用户的分页列表。

<Tabs items={['请求', '响应', '参数说明']}>
  <Tab>
    ```http
    GET /api/users?page=1&limit=10&search=john
    Authorization: Bearer <your-jwt-token>
    ```
  </Tab>
  <Tab>
    ```json
    {
      "users": [
        {
          "id": "clx1234567890",
          "email": "john@example.com",
          "username": "john_doe",
          "avatar": "https://oss.example.com/avatars/john.jpg",
          "createdAt": "2024-01-15T10:30:00.000Z",
          "_count": {
            "posts": 5,
            "comments": 12
          }
        }
      ],
      "pagination": {
        "page": 1,
        "limit": 10,
        "total": 1,
        "pages": 1
      }
    }
    ```

    **响应状态码**: `200 OK`
  </Tab>
  <Tab>
    **查询参数** (可选):
    - `page` (number): 页码，默认 1
    - `limit` (number): 每页数量，默认 10，最大 100
    - `search` (string): 搜索关键词，匹配用户名和邮箱
    - `orderBy` (string): 排序字段，支持 `createdAt`, `username`
    - `order` (string): 排序方向，`asc` 或 `desc`，默认 `desc`

    **请求头**:
    - `Authorization: Bearer <token>` (required)
  </Tab>
</Tabs>

### 获取用户详情

根据用户 ID 获取用户详细信息。

<Tabs items={['请求', '响应', '错误处理']}>
  <Tab>
    ```http
    GET /api/users/clx1234567890
    ```

    **路径参数**:
    - `id` (string): 用户 ID
  </Tab>
  <Tab>
    ```json
    {
      "id": "clx1234567890",
      "email": "john@example.com",
      "username": "john_doe",
      "avatar": "https://oss.example.com/avatars/john.jpg",
      "createdAt": "2024-01-15T10:30:00.000Z",
      "updatedAt": "2024-01-20T15:45:00.000Z",
      "_count": {
        "posts": 5,
        "comments": 12
      },
      "posts": [
        {
          "id": "post123",
          "title": "我的第一篇文章",
          "createdAt": "2024-01-16T09:00:00.000Z",
          "views": 150,
          "likes": 8
        }
      ]
    }
    ```

    **响应状态码**: `200 OK`
  </Tab>
  <Tab>
    **404 Not Found** - 用户不存在
    ```json
    {
      "error": "用户不存在"
    }
    ```

    **500 Internal Server Error** - 服务器错误
    ```json
    {
      "error": "服务器错误"
    }
    ```
  </Tab>
</Tabs>

### 更新用户信息

更新当前认证用户的信息。

<Callout type="warning">
此接口只能更新当前认证用户的信息，不能更新其他用户。
</Callout>

<Tabs items={['请求', '响应', '权限验证']}>
  <Tab>
    ```http
    PUT /api/users/clx1234567890
    Authorization: Bearer <your-jwt-token>
    Content-Type: application/json

    {
      "username": "new_username",
      "avatar": "https://oss.example.com/new-avatar.jpg"
    }
    ```

    **可更新字段**:
    - `username` (string): 新用户名
    - `avatar` (string): 头像 URL
    - `email` (string): 新邮箱地址

    **不可更新字段**:
    - `id`, `createdAt`, `password` (密码需要专门的接口)
  </Tab>
  <Tab>
    ```json
    {
      "id": "clx1234567890",
      "email": "john@example.com",
      "username": "new_username",
      "avatar": "https://oss.example.com/new-avatar.jpg",
      "updatedAt": "2024-01-20T16:00:00.000Z"
    }
    ```

    **响应状态码**: `200 OK`
  </Tab>
  <Tab>
    **401 Unauthorized** - 未认证
    ```json
    {
      "error": "未授权访问"
    }
    ```

    **403 Forbidden** - 权限不足
    ```json
    {
      "error": "权限不足",
      "message": "只能更新自己的信息"
    }
    ```

    **409 Conflict** - 数据冲突
    ```json
    {
      "error": "用户名已存在"
    }
    ```
  </Tab>
</Tabs>

### 删除用户

删除指定用户（管理员权限或本人）。

<Callout type="error">
此操作不可逆，会同时删除用户的所有文章和评论。
</Callout>

<Tabs items={['请求', '响应', '级联删除']}>
  <Tab>
    ```http
    DELETE /api/users/clx1234567890
    Authorization: Bearer <your-jwt-token>
    ```

    **请求头**:
    - `Authorization: Bearer <token>` (required)
    
    **路径参数**:
    - `id` (string): 要删除的用户 ID
  </Tab>
  <Tab>
    ```json
    {
      "message": "用户删除成功",
      "deletedUser": {
        "id": "clx1234567890",
        "username": "deleted_user"
      },
      "deletedRelated": {
        "posts": 5,
        "comments": 12
      }
    }
    ```

    **响应状态码**: `200 OK`
  </Tab>
  <Tab>
    删除用户时会级联删除以下关联数据：
    - 用户的所有文章 (`posts`)
    - 用户的所有评论 (`comments`)
    - 用户上传的文件记录
    - 用户的会话信息

    **数据库约束**:
    ```prisma
    model Post {
      author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
    }

    model Comment {
      author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
    }
    ```
  </Tab>
</Tabs>

### 获取用户文章

获取指定用户的文章列表。

<Tabs items={['请求', '响应', '过滤选项']}>
  <Tab>
    ```http
    GET /api/users/clx1234567890/posts?published=true&limit=5
    ```
  </Tab>
  <Tab>
    ```json
    {
      "posts": [
        {
          "id": "post123",
          "title": "Next.js 15 新特性解析",
          "content": "文章内容摘要...",
          "published": true,
          "category": "技术",
          "difficulty": "中级",
          "tags": ["Next.js", "React", "前端"],
          "coverImage": "https://oss.example.com/covers/post123.jpg",
          "views": 150,
          "likes": 8,
          "createdAt": "2024-01-16T09:00:00.000Z",
          "_count": {
            "comments": 3
          }
        }
      ],
      "pagination": {
        "page": 1,
        "limit": 5,
        "total": 5,
        "pages": 1
      }
    }
    ```

    **响应状态码**: `200 OK`
  </Tab>
  <Tab>
    **查询参数**:
    - `published` (boolean): 是否只显示已发布文章，默认 `true`
    - `category` (string): 按分类过滤
    - `difficulty` (string): 按难度过滤
    - `page` (number): 页码，默认 1
    - `limit` (number): 每页数量，默认 10
    - `orderBy` (string): 排序字段，支持 `createdAt`, `views`, `likes`
    - `order` (string): 排序方向，默认 `desc`

    **可用的过滤值**:
    - `category`: "技术", "生活", "学习", "其他"
    - `difficulty`: "初级", "中级", "高级"
  </Tab>
</Tabs>

## 认证说明

### JWT Token 格式

```typescript
// Token payload
interface JWTPayload {
  userId: string
  username: string
  email: string
  iat: number  // 签发时间
  exp: number  // 过期时间
}
```

### 请求头设置

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Token 获取

通过登录接口获取 Token：

```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

## 数据验证

### 输入验证规则

```typescript
// 用户注册验证
const registerSchema = {
  email: {
    required: true,
    format: 'email',
    maxLength: 255
  },
  username: {
    required: true,
    minLength: 3,
    maxLength: 20,
    pattern: /^[a-zA-Z0-9_]+$/
  },
  password: {
    required: true,
    minLength: 6,
    maxLength: 128
  }
}

// 用户更新验证
const updateSchema = {
  username: {
    optional: true,
    minLength: 3,
    maxLength: 20,
    pattern: /^[a-zA-Z0-9_]+$/
  },
  email: {
    optional: true,
    format: 'email',
    maxLength: 255
  },
  avatar: {
    optional: true,
    format: 'url',
    maxLength: 500
  }
}
```

## 缓存策略

### 缓存键规则

```typescript
const CACHE_KEYS = {
  USER_PROFILE: (id: string) => `user:${id}`,
  USER_POSTS: (id: string, page: number) => `user:${id}:posts:${page}`,
  USER_LIST: (page: number) => `users:list:${page}`,
}

const CACHE_TTL = {
  USER_PROFILE: 600,    // 10分钟
  USER_POSTS: 300,      // 5分钟  
  USER_LIST: 180,       // 3分钟
}
```

### 缓存失效

- 用户信息更新时：清除 `user:{id}` 缓存
- 用户删除时：清除所有相关缓存
- 用户发布文章时：清除 `user:{id}:posts:*` 缓存

## 错误代码说明

| 状态码 | 错误代码 | 描述 |
|--------|----------|------|
| 400 | `VALIDATION_ERROR` | 请求参数验证失败 |
| 400 | `USER_EXISTS` | 用户已存在（邮箱或用户名重复） |
| 401 | `UNAUTHORIZED` | 未提供有效的认证令牌 |
| 403 | `FORBIDDEN` | 权限不足，无法执行操作 |
| 404 | `USER_NOT_FOUND` | 用户不存在 |
| 409 | `CONFLICT` | 数据冲突（如用户名已被占用） |
| 429 | `RATE_LIMIT_EXCEEDED` | 请求频率超过限制 |
| 500 | `INTERNAL_ERROR` | 服务器内部错误 |

## 使用示例

### JavaScript/TypeScript

```typescript
// 用户注册
async function registerUser(userData: {
  email: string
  username: string
  password: string
}) {
  const response = await fetch('/api/users', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(userData),
  })
  
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error || '注册失败')
  }
  
  return response.json()
}

// 获取用户信息（带缓存）
async function getUserProfile(userId: string, token?: string) {
  const headers: HeadersInit = {}
  if (token) {
    headers.Authorization = `Bearer ${token}`
  }
  
  const response = await fetch(`/api/users/${userId}`, {
    headers,
  })
  
  if (!response.ok) {
    throw new Error('获取用户信息失败')
  }
  
  return response.json()
}

// 更新用户信息
async function updateUser(
  userId: string, 
  updateData: Partial<User>,
  token: string
) {
  const response = await fetch(`/api/users/${userId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
    },
    body: JSON.stringify(updateData),
  })
  
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error || '更新失败')
  }
  
  return response.json()
}
```

### cURL 示例

```bash
# 注册用户
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "testuser",
    "password": "password123"
  }'

# 获取用户列表（需要认证）
curl -X GET "http://localhost:3000/api/users?page=1&limit=10" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 获取用户详情
curl -X GET http://localhost:3000/api/users/USER_ID

# 更新用户信息
curl -X PUT http://localhost:3000/api/users/USER_ID \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "username": "newusername"
  }'

# 删除用户
curl -X DELETE http://localhost:3000/api/users/USER_ID \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## 相关链接

- [认证 API](/api-reference/authentication) - 用户登录、注册、Token 管理
- [文章管理 API](/api-reference/posts) - 文章相关操作
- [文件上传 API](/api-reference/uploads) - 头像上传功能
- [错误处理](/api-reference/error-handling) - 统一错误响应格式

