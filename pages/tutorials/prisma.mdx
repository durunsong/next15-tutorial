import { Callout, Steps, Tab, Tabs } from 'nextra/components';

# Prisma 数据库教程

<Callout type="info" emoji="ℹ️">
  本教程将带你深入了解 Prisma ORM 的使用，包含真实的数据库操作演示。
</Callout>

## 什么是 Prisma？

Prisma 是一个现代化的数据库工具包，包含：

- **Prisma Client**: 类型安全的数据库客户端
- **Prisma Migrate**: 数据库迁移工具
- **Prisma Studio**: 数据库可视化管理工具

## 项目中的数据库结构

我们的项目使用 PostgreSQL 数据库，包含以下表结构：

<Tabs items={['用户表', '文章表', '评论表', '文件表']}>
  <Tab>
    ```prisma filename="schema.prisma" {3-22}
    model User {
      id        String    @id @default(cuid())
      email     String    @unique
      username  String    @unique
      password  String
      avatar    String?
      createdAt DateTime  @default(now())
      updatedAt DateTime  @updatedAt
      comments  Comment[]
      posts     Post[]

      @@map("users")
    }
    ```

  </Tab>
  <Tab>
    ```prisma filename="schema.prisma" {24-42}
    model Post {
      id         String    @id @default(cuid())
      title      String
      content    String
      published  Boolean   @default(false)
      category   String
      difficulty String
      tags       String[]
      coverImage String?
      views      Int       @default(0)
      likes      Int       @default(0)
      createdAt  DateTime  @default(now())
      updatedAt  DateTime  @updatedAt
      authorId   String
      comments   Comment[]
      author     User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

      @@map("posts")
    }
    ```

  </Tab>
  <Tab>
    ```prisma filename="schema.prisma" {44-55}
    model Comment {
      id        String   @id @default(cuid())
      content   String
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      postId    String
      authorId  String
      author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
      post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

      @@map("comments")
    }
    ```

  </Tab>
  <Tab>
    ```prisma filename="schema.prisma" {57-68}
    model file_uploads {
      id           String   @id
      filename     String
      originalName String
      mimeType     String
      size         Int
      url          String
      bucket       String
      key          String
      uploadedBy   String?
      createdAt    DateTime @default(now())
    }
    ```
  </Tab>
</Tabs>

## 基础操作演示

### 1. 创建用户

<Steps>

### 导入 Prisma 客户端

```typescript filename="lib/prisma.ts"
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient();

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

### 创建用户 API

```typescript filename="app/api/users/route.ts" {1,4-5,8-20}
import bcrypt from 'bcryptjs';

import { NextRequest, NextResponse } from 'next/server';

import { prisma } from '@/lib/prisma';

export async function POST(req: NextRequest) {
  try {
    const { email, username, password } = await req.json();

    // 检查用户是否已存在
    const existingUser = await prisma.user.findFirst({
      where: {
        OR: [{ email }, { username }],
      },
    });

    if (existingUser) {
      return NextResponse.json({ error: '用户已存在' }, { status: 400 });
    }

    // 加密密码
    const hashedPassword = await bcrypt.hash(password, 12);

    // 创建用户
    const user = await prisma.user.create({
      data: {
        email,
        username,
        password: hashedPassword,
      },
      select: {
        id: true,
        email: true,
        username: true,
        createdAt: true,
      },
    });

    return NextResponse.json(user, { status: 201 });
  } catch (error) {
    console.error('创建用户失败:', error);
    return NextResponse.json({ error: '服务器错误' }, { status: 500 });
  }
}
```

### 测试创建用户

你可以通过以下方式测试用户创建：

```bash
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "testuser",
    "password": "password123"
  }'
```

</Steps>

### 2. 查询用户

<Tabs items={['获取所有用户', '根据 ID 查询', '分页查询']}>
  <Tab>
    ```typescript filename="app/api/users/route.ts"
    export async function GET() {
      try {
        const users = await prisma.user.findMany({
          select: {
            id: true,
            email: true,
            username: true,
            avatar: true,
            createdAt: true,
            _count: {
              select: {
                posts: true,
                comments: true,
              }
            }
          },
          orderBy: {
            createdAt: 'desc'
          }
        })
        
        return NextResponse.json(users)
      } catch (error) {
        console.error('查询用户失败:', error)
        return NextResponse.json(
          { error: '服务器错误' },
          { status: 500 }
        )
      }
    }
    ```
  </Tab>
  <Tab>
    ```typescript filename="app/api/users/[id]/route.ts"
    export async function GET(
      req: NextRequest,
      { params }: { params: { id: string } }
    ) {
      try {
        const user = await prisma.user.findUnique({
          where: { id: params.id },
          include: {
            posts: {
              take: 5,
              orderBy: { createdAt: 'desc' },
              select: {
                id: true,
                title: true,
                createdAt: true,
                views: true,
                likes: true,
              }
            },
            _count: {
              select: {
                posts: true,
                comments: true,
              }
            }
          }
        })
        
        if (!user) {
          return NextResponse.json(
            { error: '用户不存在' },
            { status: 404 }
          )
        }
        
        // 不返回密码
        const { password, ...userWithoutPassword } = user
        return NextResponse.json(userWithoutPassword)
      } catch (error) {
        console.error('查询用户失败:', error)
        return NextResponse.json(
          { error: '服务器错误' },
          { status: 500 }
        )
      }
    }
    ```
  </Tab>
  <Tab>
    ```typescript filename="app/api/users/route.ts"
    export async function GET(req: NextRequest) {
      try {
        const { searchParams } = new URL(req.url)
        const page = parseInt(searchParams.get('page') || '1')
        const limit = parseInt(searchParams.get('limit') || '10')
        const skip = (page - 1) * limit
        
        const [users, total] = await Promise.all([
          prisma.user.findMany({
            skip,
            take: limit,
            select: {
              id: true,
              email: true,
              username: true,
              avatar: true,
              createdAt: true,
            },
            orderBy: {
              createdAt: 'desc'
            }
          }),
          prisma.user.count()
        ])
        
        return NextResponse.json({
          users,
          pagination: {
            page,
            limit,
            total,
            pages: Math.ceil(total / limit)
          }
        })
      } catch (error) {
        console.error('查询用户失败:', error)
        return NextResponse.json(
          { error: '服务器错误' },
          { status: 500 }
        )
      }
    }
    ```
  </Tab>
</Tabs>

## 高级查询技巧

### 1. 关联查询

```typescript filename="例子：获取用户及其文章"
const userWithPosts = await prisma.user.findUnique({
  where: { id: userId },
  include: {
    posts: {
      where: { published: true },
      include: {
        comments: {
          take: 3,
          orderBy: { createdAt: 'desc' },
          include: {
            author: {
              select: {
                username: true,
                avatar: true,
              },
            },
          },
        },
        _count: {
          select: {
            comments: true,
          },
        },
      },
      orderBy: { createdAt: 'desc' },
    },
  },
});
```

### 2. 聚合查询

```typescript filename="例子：统计数据"
const statistics = await prisma.user.aggregate({
  _count: {
    id: true,
  },
  _avg: {
    posts: {
      _count: {
        select: {
          comments: true,
        },
      },
    },
  },
});

// 或者使用 groupBy
const usersByMonth = await prisma.user.groupBy({
  by: ['createdAt'],
  _count: {
    id: true,
  },
  orderBy: {
    createdAt: 'asc',
  },
});
```

### 3. 事务操作

<Callout type="warning" emoji="⚠️">
  在进行批量操作或需要保证数据一致性时，务必使用事务。
</Callout>

```typescript filename="例子：创建文章和通知"
const result = await prisma.$transaction(async tx => {
  // 创建文章
  const post = await tx.post.create({
    data: {
      title: '新文章',
      content: '文章内容',
      authorId: userId,
      category: '技术',
      difficulty: '初级',
    },
  });

  // 更新用户文章数量（如果有相关计数字段）
  const updatedUser = await tx.user.update({
    where: { id: userId },
    data: {
      // 假设有 postsCount 字段
      // postsCount: { increment: 1 }
    },
  });

  return { post, user: updatedUser };
});
```

## 性能优化

### 1. 选择字段

```typescript
// ❌ 不好的做法 - 获取所有字段
const users = await prisma.user.findMany()

// ✅ 好的做法 - 只选择需要的字段
const users = await prisma.user.findMany({
  select: {
    id: true,
    username: true,
    email: true,
  }
})
```

### 2. 分页查询

```typescript
// ✅ 使用 cursor-based 分页（推荐用于大数据集）
const posts = await prisma.post.findMany({
  take: 10,
  cursor: lastPostId ? { id: lastPostId } : undefined,
  skip: lastPostId ? 1 : 0,
  orderBy: { createdAt: 'desc' }
})

// ✅ 使用 offset-based 分页（适用于小数据集）
const posts = await prisma.post.findMany({
  skip: (page - 1) * limit,
  take: limit,
  orderBy: { createdAt: 'desc' }
})
```

### 3. 数据库索引

确保在 schema.prisma 中为经常查询的字段添加索引：

```prisma filename="schema.prisma"
model Post {
  id        String   @id @default(cuid())
  title     String
  category  String
  published Boolean  @default(false)
  authorId  String
  createdAt DateTime @default(now())

  // 添加索引
  @@index([category])
  @@index([published])
  @@index([authorId])
  @@index([createdAt])
}
```

## 真实演示

访问以下页面查看真实的数据库操作演示：

- [数据库管理页面](/database) - 查看和管理用户、文章数据
- [用户注册演示](/auth/register) - 实际的用户创建流程
- [文章管理演示](/posts) - 文章的 CRUD 操作

<Callout type="info" emoji="💡">
  这些演示页面连接真实的 PostgreSQL 数据库，你可以看到实际的数据操作效果。
</Callout>

## 常见问题

### Q: 如何处理数据库连接？

A: Prisma Client 会自动管理连接池，但在 serverless 环境中建议使用单例模式：

```typescript filename="lib/prisma.ts"
import { PrismaClient } from '@prisma/client';

declare global {
  var __prisma: PrismaClient | undefined;
}

const prisma = globalThis.__prisma ?? new PrismaClient();

if (process.env.NODE_ENV !== 'production') globalThis.__prisma = prisma;

export default prisma;
```

### Q: 如何处理数据验证？

A: 建议结合 Zod 进行数据验证：

```typescript
import { z } from 'zod';

const createUserSchema = z.object({
  email: z.string().email(),
  username: z.string().min(3).max(20),
  password: z.string().min(6),
});

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const { email, username, password } = createUserSchema.parse(body);

    // 继续处理...
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: '数据验证失败', details: error.errors }, { status: 400 });
    }
    // 处理其他错误...
  }
}
```

## 下一步

- 学习 [Redis 缓存教程](/tutorials/redis) 来优化数据库查询性能
- 查看 [API 设计教程](/tutorials/api-design) 了解更多 API 最佳实践
- 探索 [性能优化教程](/tutorials/performance) 提升应用性能
