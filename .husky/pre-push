#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸš€ Starting pre-push checks..."

# èŽ·å–å½“å‰åˆ†æ”¯
current_branch=$(git branch --show-current)
echo "ðŸ“‹ Current branch: $current_branch"

# æ£€æŸ¥æ˜¯å¦ä¸ºä¿æŠ¤åˆ†æ”¯ï¼ˆmain, master, developï¼‰
protected_branches="main master develop"
for branch in $protected_branches; do
    if [ "$current_branch" = "$branch" ]; then
        echo "âš ï¸  Pushing to protected branch '$branch'"
        echo "ðŸ”’ Running enhanced checks..."
        enhanced_checks=true
        break
    fi
done

# 1. è¿è¡Œå®Œæ•´çš„ lint æ£€æŸ¥
echo "ðŸ“ Running full ESLint check..."
pnpm lint

if [ $? -ne 0 ]; then
    echo "âŒ ESLint checks failed!"
    echo "ðŸ’¡ Run 'pnpm lint:fix' to auto-fix issues"
    exit 1
fi

# 2. è¿è¡Œç±»åž‹æ£€æŸ¥
echo "ðŸ” Running TypeScript type check..."
pnpm type-check

if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type check failed!"
    exit 1
fi

# 3. æ£€æŸ¥ä»£ç æ ¼å¼
echo "âœ¨ Checking code formatting..."
pnpm format:check

if [ $? -ne 0 ]; then
    echo "âŒ Code formatting check failed!"
    echo "ðŸ’¡ Run 'pnpm format' to fix formatting issues"
    exit 1
fi

# 4. è¿è¡Œå®Œæ•´æž„å»º
echo "ðŸ”§ Running full build..."
pnpm build

if [ $? -ne 0 ]; then
    echo "âŒ Build failed!"
    echo "ðŸ’¡ Fix build errors before pushing"
    exit 1
fi

# 5. å¯¹äºŽä¿æŠ¤åˆ†æ”¯ï¼Œè¿è¡Œé¢å¤–æ£€æŸ¥
if [ "$enhanced_checks" = true ]; then
    echo "ðŸ”’ Running enhanced checks for protected branch..."

    # è¿è¡Œå®Œæ•´çš„éªŒè¯è„šæœ¬
    if grep -q '"validate"' package.json; then
        echo "âœ… Running validation script..."
        pnpm validate

        if [ $? -ne 0 ]; then
            echo "âŒ Validation failed!"
            exit 1
        fi
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
    if ! git diff --quiet || ! git diff --cached --quiet; then
        echo "âŒ There are uncommitted changes!"
        echo "ðŸ’¡ Please commit or stash all changes before pushing"
        exit 1
    fi
fi

# 6. è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
if [ -f "jest.config.js" ] || [ -f "vitest.config.ts" ] || grep -q '"test"' package.json; then
    echo "ðŸ§ª Running tests..."
    if [ "$enhanced_checks" = true ]; then
        # å¯¹ä¿æŠ¤åˆ†æ”¯è¿è¡Œå®Œæ•´æµ‹è¯•
        pnpm test --run
    else
        # å¯¹åŠŸèƒ½åˆ†æ”¯è¿è¡Œå¿«é€Ÿæµ‹è¯•
        pnpm test --run --passWithNoTests 2>/dev/null || true
    fi

    if [ $? -ne 0 ] && [ "$enhanced_checks" = true ]; then
        echo "âŒ Tests failed!"
        exit 1
    fi
fi

# æ¸…ç†æž„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼‰
echo "ðŸ§¹ Cleaning up build artifacts..."
pnpm clean:cache 2>/dev/null || true

echo "âœ… All pre-push checks passed!"
echo "ðŸŽ‰ Ready to push to $current_branch!"

