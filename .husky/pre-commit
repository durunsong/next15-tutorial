echo "ğŸš€ Starting pre-commit checks..."

# 1. æ£€æŸ¥ä»£ç é£æ ¼å’Œ lint
echo "ğŸ“ Running lint-staged (ESLint + Prettier)..."
npx lint-staged

if [ $? -ne 0 ]; then
    echo "âŒ Code style checks failed!"
    exit 1
fi

# 2. æ£€æŸ¥ TypeScript ç±»å‹
echo "ğŸ” Running TypeScript type check..."
pnpm type-check

if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type check failed!"
    exit 1
fi

# 3. è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
if [ -f "jest.config.js" ] || [ -f "vitest.config.ts" ] || grep -q '"test"' package.json; then
    echo "ğŸ§ª Running tests..."
    pnpm test --run --passWithNoTests 2>/dev/null || true
fi

# 4. æ£€æŸ¥ Prisma schemaï¼ˆå¦‚æœæœ‰å˜æ›´ï¼‰
if git diff --cached --name-only | grep -q "prisma/schema.prisma"; then
    echo "ğŸ—„ï¸ Prisma schema changed, running generate..."
    pnpm db:generate

    if [ $? -ne 0 ]; then
        echo "âŒ Prisma generate failed!"
        exit 1
    fi
fi

# 5. æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸï¼ˆè½»é‡çº§æ£€æŸ¥ï¼‰
echo "ğŸ”§ Running quick build check..."
pnpm run build --dry-run 2>/dev/null || {
    echo "âš ï¸  Build check skipped (not supported), will verify in pre-push"
}

echo "âœ… All pre-commit checks passed!"
echo "ğŸ“¤ Ready to commit!"
