echo "🚀 Starting pre-commit checks..."

# 1. 检查代码风格和 lint
echo "📝 Running lint-staged (ESLint + Prettier)..."
npx lint-staged

if [ $? -ne 0 ]; then
    echo "❌ Code style checks failed!"
    exit 1
fi

# 2. 检查 TypeScript 类型
echo "🔍 Running TypeScript type check..."
pnpm type-check

if [ $? -ne 0 ]; then
    echo "❌ TypeScript type check failed!"
    exit 1
fi

# 3. 检查 Prisma schema（如果有变更）
if git diff --cached --name-only | grep -q "prisma/schema.prisma"; then
    echo "🗄️ Prisma schema changed, running generate..."
    pnpm db:generate

    if [ $? -ne 0 ]; then
        echo "❌ Prisma generate failed!"
        exit 1
    fi
fi

# 4. 快速测试（仅检查语法）
if [ -f "jest.config.js" ] || [ -f "vitest.config.ts" ] || grep -q '"test"' package.json; then
    echo "🧪 Running quick test check..."
    pnpm test --run --passWithNoTests 2>/dev/null || true
fi

echo "✅ All pre-commit checks passed!"
echo "📤 Ready to commit!"
echo "💡 Build verification will happen during push"
